<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <title>BudÅ¼etDomowy â€“ klasyfikacja</title>
    <style>
        body {
            background-color: #1e1e2f;
            color: #e6e6f0;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
        }

        h2 {
            color: #00aaff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        td, th {
            border-bottom: 1px solid #333;
            padding: 6px 8px;
            vertical-align: top;
        }

        select, input[type="text"] {
            background-color: #2b2b3c;
            color: #fff;
            border: 1px solid #444;
            padding: 4px;
            border-radius: 4px;
        }

        button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

            button:hover {
                background-color: #0088ff;
            }

        .log {
            white-space: pre-wrap;
            background-color: #11111a;
            padding: 8px;
            border-radius: 6px;
            height: 180px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #333;
        }

        .small {
            font-size: 12px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <h2>BudÅ¼etDomowy â€“ klasyfikacja transakcji</h2>
    <div id="app">
        <p>Oczekiwanie na dane...</p>
    </div>

    <script>
        const app = document.getElementById("app");

        window.chrome.webview.addEventListener("message", event => {
            const data = event.data;
            if (!data) return;

            if (data.cmd === "classify") {
                showClassification(data.items);
            }
            else if (data.cmd === "transactionsLoaded") {
                showTransactions(data.items);
            }
            else if (data.cmd === "log") {
                showLog(data.text);
            }
        });

        function showClassification(items) {
            if (!items || items.length === 0) {
                app.innerHTML = "<p>Brak transakcji do klasyfikacji.</p>";
                return;
            }

            let html = `<table>
                    <tr>
                        <th>Data</th>
                        <th>Odbiorca</th>
                        <th>Opis</th>
                        <th>Kwota</th>
                        <th>Kategoria</th>
                        <th>SÅ‚owo kluczowe</th>
                        <th>Zastosuj do wszystkich?</th>
                    </tr>`;

            for (const item of items) {
                // ðŸ”¹ uÅ¼ywamy teraz item.availableCategories z backendu
                const options = (item.availableCategories || [])
                    .map(cat => `<option value="${cat}">${cat}</option>`)
                    .join("");

                html += `
                        <tr>
                            <td>${item.date}</td>
                            <td>${item.recipient || ""}</td>
                            <td>${item.opis || ""}</td>
                            <td>${item.kwota}</td>
                            <td>
                                <select id="cat_${item.idx}">
                                    <option value="">-- wybierz --</option>
                                    ${options}
                                </select>
                            </td>
                            <td><input id="kw_${item.idx}" type="text" placeholder="np. fragment opisu"></td>
                            <td><input id="apply_${item.idx}" type="checkbox"></td>
                        </tr>`;
            }

            html += `</table>
                    <button onclick="sendClassification(${JSON.stringify(items.map(i => i.idx))})">Zapisz klasyfikacjÄ™</button>`;

            app.innerHTML = html;
        }

        function sendClassification(idxs) {
            const mappings = [];
            for (const idx of idxs) {
                const cat = document.getElementById("cat_" + idx)?.value || "";
                const keyword = document.getElementById("kw_" + idx)?.value || "";
                const apply = document.getElementById("apply_" + idx)?.checked || false;
                mappings.push({ idx: idx, category: cat, keyword: keyword, applyToAll: apply });
            }

            window.chrome.webview.postMessage({
                cmd: "classifyResult",
                mappings: mappings
            });

            app.innerHTML = `<p style="color:#0f0;">DziÄ™kujemy! Klasyfikacja zostaÅ‚a zapisana.</p>`;
        }

        function showTransactions(items) {
            let html = "<h3>Wczytane transakcje</h3><table>";
            html += "<tr><th>Data</th><th>Odbiorca</th><th>Opis</th><th>Kwota</th><th>Kategoria</th></tr>";
            for (const t of items) {
                html += `<tr>
                        <td>${t.date}</td>
                        <td>${t.recipient || ""}</td>
                        <td>${t.opis || ""}</td>
                        <td>${t.kwota}</td>
                        <td>${t.category}</td>
                    </tr>`;
            }
            html += "</table>";
            app.innerHTML = html;
        }

        function showLog(text) {
            app.innerHTML = `<div class="log">${text}</div>`;
        }
    </script>
</body>
</html>
